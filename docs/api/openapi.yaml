openapi: 3.1.0
info:
  title: Wine App API
  version: 0.1.0
  description: Current API endpoints for health, authentication, wines, and wine photos.
servers:
  - url: http://localhost:8080
paths:
  /api:
    get:
      summary: Health check
      operationId: getApiHealth
      tags: [System]
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                required: [status, service]
                properties:
                  status:
                    type: string
                    example: ok
                  service:
                    type: string
                    example: wine-api
  /guide.md:
    get:
      summary: Markdown API guide
      operationId: getApiGuideMarkdown
      tags: [System]
      responses:
        '200':
          description: Human-readable API guide in Markdown format
          content:
            text/markdown:
              schema:
                type: string
  /api/auth/login:
    post:
      summary: Login with email and password (session cookie)
      operationId: postAuthLogin
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authenticated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUserResponse'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/auth/me:
    get:
      summary: Get current authenticated user
      operationId: getAuthMe
      tags: [Auth]
      responses:
        '200':
          description: Authenticated user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUserResponse'
        '401':
          description: Unauthenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/auth/logout:
    post:
      summary: Logout current session
      operationId: postAuthLogout
      tags: [Auth]
      responses:
        '204':
          description: Logged out (idempotent)
  /api/grapes:
    get:
      summary: List all grapes
      operationId: getGrapesList
      tags: [Grape]
      responses:
        '200':
          description: Grapes list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GrapeListResponse'
  /api/wines:
    get:
      summary: List wines (paginated)
      operationId: getWinesList
      tags: [Wine]
      parameters:
        - in: query
          name: page
          description: Page number (1-based)
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: limit
          description: Items per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - in: query
          name: search
          description: Search by wine name, winery, DO name, or region
          schema:
            type: string
        - in: query
          name: wine_type
          schema:
            type: string
            enum: [red, white, rose, sparkling, sweet, fortified]
        - in: query
          name: country
          schema:
            type: string
            enum: [spain, france, italy, portugal, germany, argentina, chile, united_states, south_africa, australia]
        - in: query
          name: do_id
          description: Region/DO identifier
          schema:
            type: integer
            format: int64
            minimum: 1
        - in: query
          name: grape_id
          description: Grape variety identifier
          schema:
            type: integer
            format: int64
            minimum: 1
        - in: query
          name: score_min
          description: Minimum average review score (0..100)
          schema:
            type: integer
            minimum: 0
            maximum: 100
        - in: query
          name: score_max
          description: Maximum average review score (0..100)
          schema:
            type: integer
            minimum: 0
            maximum: 100
        - in: query
          name: score_bucket
          description: Preset score range for quick filters
          schema:
            type: string
            enum: [any, lt70, 70_80, 80_90, 90_plus]
        - in: query
          name: sort_by
          schema:
            type: string
            enum: [created_at, updated_at, name, vintage_year, score]
            default: created_at
        - in: query
          name: sort_dir
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Paginated wine list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WineListResponse'
        '400':
          description: Invalid query params
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      summary: Create wine
      operationId: postWinesCreate
      tags: [Wine]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWineRequest'
      responses:
        '201':
          description: Wine created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateWineResponse'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Foreign key reference not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/wines/{id}:
    get:
      summary: Get wine details by id
      operationId: getWineById
      tags: [Wine]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Wine details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WineDetailsResponse'
        '404':
          description: Wine not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Partially update wine by id
      operationId: putWineById
      tags: [Wine]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWineRequest'
      responses:
        '204':
          description: Wine updated successfully
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Wine or reference not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete wine by id
      operationId: deleteWineById
      tags: [Wine]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: Wine deleted successfully
        '404':
          description: Wine not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/wines/{id}/photos:
    post:
      summary: Upload or replace a wine photo by type
      operationId: postWinePhotoByWineId
      tags: [Wine]
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [type, file]
              properties:
                type:
                  type: string
                  enum: [front_label, back_label, bottle]
                file:
                  type: string
                  format: binary
      responses:
        '201':
          description: Photo created or replaced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateWinePhotoResponse'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Wine not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  schemas:
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          example: demo@example.com
        password:
          type: string
          format: password
          example: demo1234
    AuthUser:
      type: object
      required: [id, email, name, lastname]
      properties:
        id:
          type: integer
          format: int64
          example: 1
        email:
          type: string
          format: email
          example: demo@example.com
        name:
          type: string
          example: Demo
        lastname:
          type: string
          example: User
    AuthUserResponse:
      type: object
      required: [user]
      properties:
        user:
          $ref: '#/components/schemas/AuthUser'
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string
          example: Invalid credentials.
    CreateWineGrapeInput:
      type: object
      required: [grape_id]
      properties:
        grape_id:
          type: integer
          format: int64
          example: 2
        percentage:
          type: number
          format: float
          minimum: 0
          maximum: 100
          example: 60.5
    CreateWinePurchaseInput:
      type: object
      required: [place, price_paid, purchased_at]
      properties:
        place:
          $ref: '#/components/schemas/CreateWinePlaceInput'
        price_paid:
          type: number
          format: float
          minimum: 0
          example: 19.95
        purchased_at:
          type: string
          format: date-time
          example: '2026-03-01T10:00:00Z'
    CreateWinePlaceInput:
      type: object
      required: [place_type, name, country]
      description: For supermarket, address must be null and city is optional. For restaurant, both address and city are required.
      properties:
        place_type:
          type: string
          enum: [supermarket, restaurant]
        name:
          type: string
          example: Casa Paco
        address:
          type: string
          nullable: true
          example: Calle A 123
        city:
          type: string
          nullable: true
          example: Madrid
        country:
          type: string
          enum: [spain, france, italy, portugal, germany, argentina, chile, united_states, south_africa, australia]
    CreateWineAwardInput:
      type: object
      required: [name]
      properties:
        name:
          type: string
          enum: [penin, parker, wine_spectator, decanter, james_suckling, guia_proensa]
          example: parker
        score:
          type: number
          format: float
          minimum: 0
          maximum: 100
          example: 92.5
        year:
          type: integer
          minimum: 1800
          maximum: 2200
          example: 2025
    CreateWineRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          example: Vina del Sol
        winery:
          type: string
          example: Bodega La Sierra
        wine_type:
          type: string
          enum: [red, white, rose, sparkling, sweet, fortified]
        do_id:
          type: integer
          format: int64
          example: 1
        country:
          type: string
          enum: [spain, france, italy, portugal, germany, argentina, chile, united_states, south_africa, australia]
        aging_type:
          type: string
          enum: [young, crianza, reserve, grand_reserve]
        vintage_year:
          type: integer
          minimum: 1800
          maximum: 2200
        alcohol_percentage:
          type: number
          format: float
          minimum: 0
          maximum: 100
        grapes:
          type: array
          items:
            $ref: '#/components/schemas/CreateWineGrapeInput'
        purchases:
          type: array
          items:
            $ref: '#/components/schemas/CreateWinePurchaseInput'
        awards:
          type: array
          items:
            $ref: '#/components/schemas/CreateWineAwardInput'
    CreateWineResponse:
      type: object
      required: [wine]
      properties:
        wine:
          type: object
          required: [id]
          properties:
            id:
              type: integer
              format: int64
              example: 42
    UpdateWineRequest:
      type: object
      properties:
        name:
          type: string
        winery:
          type: string
          nullable: true
        wine_type:
          type: string
          enum: [red, white, rose, sparkling, sweet, fortified]
          nullable: true
        do_id:
          type: integer
          format: int64
          nullable: true
        country:
          type: string
          enum: [spain, france, italy, portugal, germany, argentina, chile, united_states, south_africa, australia]
          nullable: true
        aging_type:
          type: string
          enum: [young, crianza, reserve, grand_reserve]
          nullable: true
        vintage_year:
          type: integer
          minimum: 1800
          maximum: 2200
          nullable: true
        alcohol_percentage:
          type: number
          format: float
          minimum: 0
          maximum: 100
          nullable: true
    CreateWinePhotoResponse:
      type: object
      required: [photo]
      properties:
        photo:
          type: object
          required: [id, wine_id, type, url, hash, size, extension]
          properties:
            id:
              type: integer
              format: int64
            wine_id:
              type: integer
              format: int64
            type:
              type: string
              enum: [front_label, back_label, bottle]
            url:
              type: string
              example: /images/wines/1/abc123.jpg
            hash:
              type: string
              maxLength: 16
              example: e3b0c44298fc1c14
            size:
              type: integer
              format: int64
              example: 145233
            extension:
              type: string
              example: jpg
    WineDo:
      type: object
      required: [id, name, region, country, country_code]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        region:
          type: string
        country:
          type: string
          enum: [spain, france, italy, portugal, germany, argentina, chile, united_states, south_africa, australia]
        country_code:
          type: string
          minLength: 2
          maxLength: 2
          example: ES
    WineDetailGrape:
      type: object
      required: [id, name, color, percentage]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        color:
          type: string
          enum: [red, white]
        percentage:
          type: number
          format: float
          nullable: true
    WineDetailPurchasePlace:
      type: object
      required: [id, place_type, name, country]
      properties:
        id:
          type: integer
          format: int64
        place_type:
          type: string
          enum: [supermarket, restaurant]
        name:
          type: string
        address:
          type: string
          nullable: true
        city:
          type: string
          nullable: true
        country:
          type: string
          enum: [spain, france, italy, portugal, germany, argentina, chile, united_states, south_africa, australia]
    WineDetailPurchase:
      type: object
      required: [id, place, price_paid, purchased_at]
      properties:
        id:
          type: integer
          format: int64
        place:
          $ref: '#/components/schemas/WineDetailPurchasePlace'
        price_paid:
          type: number
          format: float
        purchased_at:
          type: string
          format: date-time
    WineDetailAward:
      type: object
      required: [id, name, score, year]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
          enum: [penin, parker, wine_spectator, decanter, james_suckling, guia_proensa]
        score:
          type: number
          format: float
          nullable: true
        year:
          type: integer
          nullable: true
    WineDetailPhoto:
      type: object
      required: [id, type, url, hash, size, extension]
      properties:
        id:
          type: integer
          format: int64
        type:
          type: string
          enum: [front_label, back_label, bottle]
          nullable: true
        url:
          type: string
        hash:
          type: string
        size:
          type: integer
          format: int64
        extension:
          type: string
    WineDetailReviewUser:
      type: object
      required: [id, name, lastname]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        lastname:
          type: string
    WineDetailReview:
      type: object
      required: [id, user, score, intensity_aroma, sweetness, acidity, tannin, body, persistence, bullets, created_at]
      properties:
        id:
          type: integer
          format: int64
        user:
          $ref: '#/components/schemas/WineDetailReviewUser'
        score:
          type: integer
          nullable: true
        intensity_aroma:
          type: integer
          minimum: 0
          maximum: 5
        sweetness:
          type: integer
          minimum: 0
          maximum: 5
        acidity:
          type: integer
          minimum: 0
          maximum: 5
        tannin:
          type: integer
          minimum: 0
          maximum: 5
          nullable: true
        body:
          type: integer
          minimum: 0
          maximum: 5
        persistence:
          type: integer
          minimum: 0
          maximum: 5
        bullets:
          type: array
          items:
            type: string
            enum: [fruity, floral, spicy, mineral, oak_forward, easy_drinking, elegant, powerful, food_friendly]
        created_at:
          type: string
          format: date-time
    WineDetails:
      type: object
      required: [id, name, winery, wine_type, do, country, aging_type, vintage_year, alcohol_percentage, created_at, updated_at, grapes, purchases, awards, photos, reviews]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        winery:
          type: string
          nullable: true
        wine_type:
          type: string
          enum: [red, white, rose, sparkling, sweet, fortified]
          nullable: true
        do:
          allOf:
            - $ref: '#/components/schemas/WineDo'
          nullable: true
        country:
          type: string
          enum: [spain, france, italy, portugal, germany, argentina, chile, united_states, south_africa, australia]
          nullable: true
        aging_type:
          type: string
          enum: [young, crianza, reserve, grand_reserve]
          nullable: true
        vintage_year:
          type: integer
          nullable: true
        alcohol_percentage:
          type: number
          format: float
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        grapes:
          type: array
          items:
            $ref: '#/components/schemas/WineDetailGrape'
        purchases:
          type: array
          items:
            $ref: '#/components/schemas/WineDetailPurchase'
        awards:
          type: array
          items:
            $ref: '#/components/schemas/WineDetailAward'
        photos:
          type: array
          items:
            $ref: '#/components/schemas/WineDetailPhoto'
        reviews:
          type: array
          items:
            $ref: '#/components/schemas/WineDetailReview'
    WineDetailsResponse:
      type: object
      required: [wine]
      properties:
        wine:
          $ref: '#/components/schemas/WineDetails'
    WineListDo:
      type: object
      required: [id, name]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
    WineListItem:
      type: object
      required: [id, name, winery, wine_type, country, do, vintage_year, avg_score, updated_at]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        winery:
          type: string
          nullable: true
        wine_type:
          type: string
          enum: [red, white, rose, sparkling, sweet, fortified]
          nullable: true
        country:
          type: string
          enum: [spain, france, italy, portugal, germany, argentina, chile, united_states, south_africa, australia]
          nullable: true
        do:
          allOf:
            - $ref: '#/components/schemas/WineListDo'
          nullable: true
        vintage_year:
          type: integer
          nullable: true
        avg_score:
          type: number
          format: float
          nullable: true
        updated_at:
          type: string
          format: date-time
    PaginationMeta:
      type: object
      required: [page, limit, total_items, total_pages, has_next, has_prev]
      properties:
        page:
          type: integer
        limit:
          type: integer
        total_items:
          type: integer
        total_pages:
          type: integer
        has_next:
          type: boolean
        has_prev:
          type: boolean
    WineListResponse:
      type: object
      required: [items, pagination]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/WineListItem'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
    GrapeListItem:
      type: object
      required: [id, name, color]
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        color:
          type: string
          enum: [red, white]
    GrapeListResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/GrapeListItem'
